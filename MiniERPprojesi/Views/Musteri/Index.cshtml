@using MiniERPprojesi.Models
@model List<v_musteriler>

@{
    ViewBag.Title = "Müşteriler";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Müşteriler</h2>

<form method="get" action="/Musteri/Index" class="form-inline mb-3">
    <label class="mr-2">Müşteri Türü:</label>
    <select name="musteriTuru" class="form-control mr-3">
        <option value="" @(ViewBag.SeciliMusteriTuru == null ? "selected" : "")>Tümünü Göster</option>
        <option value="Bireysel" @(ViewBag.SeciliMusteriTuru == "Bireysel" ? "selected" : "")>Bireysel</option>
        <option value="Kurumsal" @(ViewBag.SeciliMusteriTuru == "Kurumsal" ? "selected" : "")>Kurumsal</option>
    </select>

    <label class="mr-2">Sıralama:</label>
    <select name="siralama" class="form-control mr-3">
        <option value="" @(ViewBag.SeciliSiralama == null ? "selected" : "")>Varsayılan</option>
        <option value="az" @(ViewBag.SeciliSiralama == "az" ? "selected" : "")>A-Z</option>
        <option value="za" @(ViewBag.SeciliSiralama == "za" ? "selected" : "")>Z-A</option>
    </select>

    <button class="btn text-white" style="background-color: #003d80;">Filtrele</button>

</form>


<button class="btn btn-info mb-3" onclick="TemizleForm(); $('#musteriModalLabel').text('Yeni Müşteri Ekle'); $('#musteriModal').modal('show');">Yeni Müşteri Ekle</button>

<table class="table table-bordered table-striped mt-3">
    <thead>
        <tr>
            <th>Ad</th>
            <th>Soyad</th>
            <th>Müşteri Türü</th>
            <th>Email</th>
            <th>Telefon</th>
            <th>Adres</th>
            <th>Sil</th>
            <th>Güncelle</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var m in Model)
        {
            <tr>
                <td>@m.Ad</td>
                <td>@m.Soyad</td>
                <td>@m.MusteriTuru</td>
                <td>@m.Email</td>
                <td>@m.Telefon</td>
                <td>@m.Adres</td>
                <td><a href="#" class="btn btn-danger musteriSil" data-id="@m.MusteriID" data-ad="@m.Ad @m.Soyad">Sil</a></td>
                <td><a href="#" class="btn btn-warning musteriGuncelle" data-id="@m.MusteriID">Güncelle</a></td>
            </tr>
        }
    </tbody>
</table>

@section body {
    <!-- Müşteri Modal -->
    <div class="modal fade" id="musteriModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-info">
                    <h4 class="modal-title text-white" id="musteriModalLabel">Müşteri Bilgileri</h4>
                    <button type="button" class="close text-white" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="musteriID" />
                    <input type="hidden" id="adresID" />
                    <div class="form-group"><label>Ad:</label><input type="text" id="ad" class="form-control" /></div>
                    <div class="form-group"><label>Soyad:</label><input type="text" id="soyad" class="form-control" /></div>
                    <div class="form-group"><label>Email:</label><input type="text" id="email" class="form-control" /></div>
                    <div class="form-group"><label>Telefon:</label><input type="text" id="telefon" class="form-control" /></div>
                    <div class="form-group" id="divKimlikNo">
                        <label id="labelKimlikNo">Kimlik No / Vergi No:</label>
                        <input type="text" id="kimlikNo" class="form-control" />
                    </div>

                    <div class="form-group">
                        <label>Müşteri Türü:</label>
                        <select id="musteriTuru" class="form-control">
                            <option value="">Seçiniz</option>
                            <option value="Bireysel">Bireysel</option>
                            <option value="Kurumsal">Kurumsal</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>İl:</label>
                        <select id="ilID" class="form-control">
                            <option value="">İl Seçiniz</option>
                            @foreach (var il in ViewBag.iller)
                            {
                                <option value="@il.IlID">@il.IlAdi</option>
                            }
                        </select>
                    </div>
                    <div class="form-group"><label>İlçe:</label><select id="ilceID" class="form-control"><option value="">İlçe Seçiniz</option></select></div>
                    <div class="form-group"><label>Mahalle:</label><input type="text" id="mahalle" class="form-control" /></div>
                    <div class="form-group"><label>Sokak:</label><input type="text" id="sokak" class="form-control" /></div>
                    <div class="form-group"><label>Bina No:</label><input type="text" id="binaNo" class="form-control" /></div>
                    <div class="form-group"><label>Daire No:</label><input type="text" id="daireNo" class="form-control" /></div>
                    <div class="form-group"><label>Posta Kodu:</label><input type="text" id="postaKodu" class="form-control" /></div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button class="btn btn-secondary" data-dismiss="modal">İptal</button>
                    <button class="btn btn-success" onclick="MusteriKaydet()">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sil Modal -->
    <div class="modal fade" id="silModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header bg-danger">
                    <h4 class="modal-title text-white">Silme Onayı</h4>
                    <button class="close text-white" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    <p><strong id="silMusteriAdi" class="text-danger"></strong> isimli müşteriyi silmek istiyor musunuz?</p>
                    <input type="hidden" id="silMusteriID" />
                </div>
                <div class="modal-footer justify-content-between">
                    <button class="btn btn-secondary" data-dismiss="modal">İptal</button>
                    <button class="btn btn-danger" id="btnSilOnayla">Evet, Sil</button>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        function IlceYukle(ilID, selectedIlceID = null) {
            $.get("/Musteri/IlceleriGetir", { ilID }, function (data) {
                $("#ilceID").empty().append('<option value="">İlçe Seçiniz</option>');
                $.each(data, function (i, ilce) {
                    const selected = (selectedIlceID == ilce.IlceID) ? 'selected' : '';
                    $("#ilceID").append(`<option value="${ilce.IlceID}" ${selected}>${ilce.IlceAdi}</option>`);
                });
            });
        }

        function TemizleForm() {
            $("#musteriID, #adresID, #ad, #soyad, #email, #telefon, #kimlikNo, #mahalle, #sokak, #binaNo, #daireNo, #postaKodu").val("");
            $("#ilID").val(""); $("#ilceID").empty().append('<option value="">İlçe Seçiniz</option>');
            $("#musteriTuru").val("");
        }

        $("#ilID").change(function () {
            IlceYukle($(this).val());
        });

        function KullaniciKaydet() {
            // Önceki hataları temizle
            $(".is-invalid").removeClass("is-invalid");

            var id = $("#kullaniciID").val();
            var email = $("#email").val().trim();
            var sifre = $("#sifre").val().trim();

            // Zorunlu alanları listele
            var zorunluAlanlar = [
                "#kullaniciAdi",
                "#email",
                "#ad",
                "#soyad",
                "#rolID"
            ];

            // Eğer yeni kullanıcıysa şifre zorunlu
            if (!id) {
                zorunluAlanlar.push("#sifre");
            }

            var eksikVar = false;
            zorunluAlanlar.forEach(function (selector) {
                if ($(selector).val().trim() === "") {
                    $(selector).addClass("is-invalid");
                    eksikVar = true;
                }
            });

            if (eksikVar) {
                alert("Lütfen tüm zorunlu alanları doldurunuz.");
                return;
            }

            // E-posta geçerliliği
            if (email.indexOf("@@") === -1) {
                alert("Lütfen geçerli bir e-posta adresi giriniz. (örn: ornek@mail.com)");
                $("#email").focus();
                return;
            }
        }

        // FormData ile gönder

        $(".musteriSil").click(function () {
            $("#silMusteriID").val($(this).data("id"));
            $("#silMusteriAdi").text($(this).data("ad"));
            $("#silModal").modal("show");
        });

        $("#btnSilOnayla").click(function () {
            $.post("/Musteri/Sil/" + $("#silMusteriID").val(), function (res) {
                if (res == 0) {
                    $("#silModal").modal("hide");
                    alert("Silindi.");
                    location.reload();
                } else {
                    alert("Silme işlemi başarısız.");
                }
            });
        });

        $(".musteriGuncelle").click(function () {
            var id = $(this).data("id");
            $.get("/Musteri/MusteriGetir/" + id, function (m) {
                $("#musteriID").val(m.MusteriID);
                $("#ad").val(m.Ad);
                $("#soyad").val(m.Soyad);
                $("#email").val(m.Email);
                $("#telefon").val(m.Telefon);
                $("#kimlikNo").val(m.KimlikNo);
                $("#musteriTuru").val(m.MusteriTuru);
                $("#adresID").val(m.AdresID);
                $("#mahalle").val(m.Adres.Mahalle);
                $("#sokak").val(m.Adres.Sokak);
                $("#binaNo").val(m.Adres.BinaNo);
                $("#daireNo").val(m.Adres.DaireNo);
                $("#postaKodu").val(m.Adres.PostaKodu);
                $("#ilID").val(m.Adres.IlID);
                IlceYukle(m.Adres.IlID, m.Adres.IlceID);
                $("#musteriModalLabel").text("Müşteri Güncelle");
                $("#musteriModal").modal("show");
            });
        });

        function MusteriKaydet() {
            const zorunluAlanlar = ["#ad", "#soyad", "#email", "#telefon", "#kimlikNo", "#musteriTuru", "#mahalle", "#sokak", "#binaNo", "#ilceID"];
            let eksik = false;

            zorunluAlanlar.forEach(id => {
                if ($(id).val().trim() === "") {
                    $(id).addClass("is-invalid");
                    eksik = true;
                } else {
                    $(id).removeClass("is-invalid");
                }
            });

            if (eksik) {
                alert("Lütfen tüm zorunlu alanları doldurunuz.");
                return;
            }

            const veri = {
                MusteriID: $("#musteriID").val(),
                Ad: $("#ad").val(),
                Soyad: $("#soyad").val(),
                Email: $("#email").val(),
                Telefon: $("#telefon").val(),
                KimlikNo: $("#kimlikNo").val(),
                MusteriTuru: $("#musteriTuru").val(),
                AdresID: $("#adresID").val(),
                IlceID: $("#ilceID").val(),
                Mahalle: $("#mahalle").val(),
                Sokak: $("#sokak").val(),
                BinaNo: $("#binaNo").val(),
                DaireNo: $("#daireNo").val(),
                PostaKodu: $("#postaKodu").val()
            };

            $.post("/Musteri/Ekle", veri, function (res) {
                if (res == 0) {
                    $("#musteriModal").modal("hide");
                    alert("Kayıt başarılı.");
                    location.reload();
                } else if (res == 2) {
                    alert("Eksik alan bırakmayınız.");
                } else {
                    alert("Kayıt bulunamadı.");
                }
            }).fail(function () {
                alert("Sunucu hatası oluştu.");
            });
        }
    </script>
}
